# Cyclocross Lap Time Converter

日本のシクロクロス公式ページ（https://data.cyclocross.jp/）の機能を拡張するChrome拡張機能です。

リザルトページに表示される**経過時間（スプリットタイム）**を、**ネットラップタイム**に自動変換し、グラフ表示などの分析機能を提供します。

## 主な機能

### ✅ ラップタイム変換機能（v1.0.0）

経過時間を自動的にネットラップタイムに変換します。

#### 変換例

**変換前（経過時間）:**
| 選手 | 1周 | 2周 | 3周 | 4周 |
|------|------|--------|--------|--------|
| 積田 連 | 9:28.1 | 19:22.6 | 29:20.6 | 40:00.2 |
| 谷畑 希一 | 9:28.3 | 19:32.9 | 30:10.0 | 40:50.2 |

**変換後（ネットラップタイム）:**
| 選手 | 1周 | 2周 | 3周 | 4周 |
|------|------|------|------|-------|
| 積田 連 | 9:28.1 | 9:54.5 | 9:58.0 | 10:39.6 |
| 谷畑 希一 | 9:28.3 | 10:04.6 | 10:37.1 | 10:40.2 |

- 変換されたセルは緑色の背景で表示
- 右上に⏱アイコン
- ホバーで元の経過時間を確認可能

### ✅ ON/OFF切り替え機能（v1.1.0）

ツールバーアイコンをクリックすることで、変換機能のON/OFFを切り替えられます。

- 設定はブラウザに保存され、次回アクセス時も維持
- ページ上部に現在の状態を通知

### ✅ ベストラップのハイライト（v1.2.0）

各選手の最速ラップとレース全体の最速ラップを自動的にハイライト表示します。

- **個人ベストラップ**: 黄色で表示、★アイコン
- **レース全体ベストラップ**: オレンジ色で表示、🏆アイコン
- スタートループの検出と除外機能（v1.2.1）
- 1周目の扱い改善（v1.2.2-v1.2.6）

### ✅ グラフ表示機能（v1.3.0-v1.3.2）

ラップタイムの推移を視覚的に確認できるグラフ機能を搭載。

**主な機能:**
- **選手選択**: 名前の左側のチェックボックスで表示する選手を選択
- **1周目トグル**: スタートループの影響を除外した比較が可能
- **クイック選択**: 上位3名、全選手、すべて解除ボタン
- **グラフに移動**: テーブル上部のボタンでグラフまで素早く移動
- **自作Canvas実装**: 軽量で高速な描画
- **ダークモード対応**: システム設定に自動追従
- **レスポンシブ対応**: モバイルでも快適に操作

## インストール方法

### 開発者モードでインストール（推奨）

1. このリポジトリをクローンまたはダウンロードします
   ```bash
   git clone https://github.com/gentksb/ajocc-tools.git
   cd ajocc-tools
   ```

2. Google Chromeを開き、アドレスバーに `chrome://extensions/` と入力してEnterキーを押します

3. 右上の「デベロッパーモード」をONにします

4. 「パッケージ化されていない拡張機能を読み込む」をクリックします

5. `cyclocross-extension` フォルダを選択します

6. 拡張機能が読み込まれ、アイコンが表示されます

### Chrome Web Storeからのインストール（今後対応予定）

Chrome Web Storeへの公開を検討中です。

## 使用方法

### 基本的な使い方

1. 拡張機能をインストール後、シクロクロス公式リザルトページにアクセスします
   - 例: https://data.cyclocross.jp/race/24830

2. ページが読み込まれると、自動的にラップタイムが変換されます

3. 変換を無効にしたい場合は、ツールバーのアイコンをクリックしてOFFにします

### グラフ機能の使い方

1. **選手を選択**: テーブル内の選手名の左側にあるチェックボックスをクリック
   - チェックを入れると自動的にグラフが表示されます

2. **クイック選択を利用**:
   - 「上位3名」: 1位〜3位の選手を一括選択
   - 「全選手」: すべての選手を一括選択
   - 「すべて解除」: すべての選択を解除

3. **1周目の表示切替**:
   - 「1周目を表示」チェックボックスで1周目を含めるか選択
   - スタートループが短い大会では、OFFにすることで純粋な周回タイムを比較できます

4. **グラフへ移動**:
   - テーブル上部の「⬇️ グラフに移動」ボタンで素早くグラフまでスクロール
   - テーブル下部の「📊 グラフを表示/非表示」ボタンでグラフの表示を切り替え

## 対応する時間フォーマット

- `SS.d` （例: 45.2）- 1分未満のラップ
- `MM:SS` （例: 9:28）
- `MM:SS.d` （例: 9:28.1）- 実際のページで使用
- `MM:SS.dd` （例: 9:28.12）
- `MM:SS.ddd` （例: 9:28.123）
- `HH:MM:SS` （例: 1:09:28）
- `HH:MM:SS.d` （例: 1:09:28.1）
- `HH:MM:SS.dd` （例: 1:09:28.12）
- `HH:MM:SS.ddd` （例: 1:09:28.123）

※ 小数点以下は1桁（1/10秒）、2桁（1/100秒）、3桁（1/1000秒）に対応

## 機能詳細

### 自動検出機能

拡張機能は以下の処理を自動で行います:

1. ページ内の `table__laptime` クラスを持つテーブルを検出
2. ヘッダー行の `cell__lapat` クラスを持つ列（「1周」「2周」など）を特定
3. 各選手の経過時間を読み取り、ネットラップタイムを計算
4. スタートループを検出して、ベストラップ判定から除外
5. 変換されたセルに視覚的なマーカーを表示

**特徴:**
- 元の経過時間は `data-original-time` 属性に保存され、ホバー時に表示
- DNS（欠場）や未完走の選手は自動的にスキップ
- ページ構造の変更にも柔軟に対応

### ダークモード対応

システムのダークモード設定に自動的に対応します。グラフ、ボタン、コントロールすべてがダークモードに対応しています。

### プリント対応

印刷時は変換マーカー（背景色、アイコン）やボタン類が非表示になり、シンプルに出力されます。

## トラブルシューティング

### 拡張機能が動作しない場合

1. **ページをリロード**: Ctrl+R (Windows/Linux) または Cmd+R (Mac) でページを再読み込みしてください

2. **拡張機能の再読み込み**:
   - `chrome://extensions/` を開く
   - 本拡張機能の「再読み込み」ボタンをクリック

3. **コンソールログを確認**:
   - F12キーを押して開発者ツールを開く
   - Consoleタブを選択
   - 「Cyclocross Lap Time Converter」で始まるログメッセージを確認

### ラップタイムが変換されない場合

以下の原因が考えられます:

1. **ページ構造が想定と異なる**:
   - ページのHTMLが更新された可能性があります
   - Issueを作成して報告してください

2. **時間フォーマットが未対応**:
   - 対応していない時間フォーマットの可能性があります
   - Issueで具体例を報告してください

3. **テーブル構造の検出に失敗**:
   - ラップタイム列を自動検出できなかった可能性があります
   - ページのURLとともにIssueを作成してください

### グラフが表示されない場合

1. **選手を選択**: チェックボックスをクリックして選手を選択してください
2. **ブラウザの互換性**: Chrome/Edgeの最新版を使用してください
3. **コンソールエラーを確認**: F12で開発者ツールを開き、エラーがないか確認してください

## 今後の予定

### 検討中の機能

- **CSVエクスポート機能**: 変換後のラップタイムをCSVでダウンロード
- **より高度なラップ比較機能**: 複数選手の差分を詳細に分析

詳細は [開発者向けドキュメント（CLAUDE.md）](./CLAUDE.md) をご覧ください。

## バージョン履歴

- **v1.3.2** (2025-01-19): チェックボックスとライダー名の表示修正
- **v1.3.1** (2025-01-19): グラフUI改善（クイック選択、上部ボタン）
- **v1.3.0** (2025-01-19): グラフ表示機能実装
- **v1.2.6** (2024-12): 1周目の扱い改善
- **v1.2.0** (2024-12): ベストラップのハイライト機能
- **v1.1.0** (2024-11): ON/OFF切り替え機能
- **v1.0.0** (2024-11): 基本的なラップタイム変換機能

## ライセンス

MIT License

## 貢献

バグ報告、機能要望、プルリクエストを歓迎します！

## 作者

[gentksb](https://github.com/gentksb)

## リンク

- [GitHub Repository](https://github.com/gentksb/ajocc-tools)
- [Issues](https://github.com/gentksb/ajocc-tools/issues)
- [Pull Requests](https://github.com/gentksb/ajocc-tools/pulls)
- [シクロクロス公式サイト](https://data.cyclocross.jp/)
