# Cyclocross Lap Time Converter

日本のシクロクロス公式ページ（https://data.cyclocross.jp/）の機能を拡張するChrome拡張機能です。

## 機能

### 第1弾: ラップタイム変換機能

リザルトページに表示される**経過時間（スプリットタイム）**を、**ネットラップタイム**に自動変換します。

#### 変換例

実際のリザルトページでの変換例（サンプル: https://data.cyclocross.jp/race/24830 より）

**変換前（経過時間）:**
| 選手 | 1周 | 2周 | 3周 | 4周 |
|------|------|--------|--------|--------|
| 積田 連 | 9:28.1 | 19:22.6 | 29:20.6 | 40:00.2 |
| 谷畑 希一 | 9:28.3 | 19:32.9 | 30:10.0 | 40:50.2 |

**変換後（ネットラップタイム）:**
| 選手 | 1周 | 2周 | 3周 | 4周 |
|------|------|------|------|-------|
| 積田 連 | 9:28.1 | 9:54.5 | 9:58.0 | 10:39.6 |
| 谷畑 希一 | 9:28.3 | 10:04.6 | 10:37.1 | 10:40.2 |

このように、各周回の実際のラップタイムが一目でわかるようになります。

## インストール方法

### 方法1: 開発者モードでインストール（推奨）

1. このリポジトリをクローンまたはダウンロードします
   ```bash
   git clone https://github.com/gentksb/ajocc-tools.git
   cd ajocc-tools
   ```

2. Google Chromeを開き、アドレスバーに `chrome://extensions/` と入力してEnterキーを押します

3. 右上の「デベロッパーモード」をONにします

4. 「パッケージ化されていない拡張機能を読み込む」をクリックします

5. `cyclocross-extension` フォルダを選択します

6. 拡張機能が読み込まれ、アイコンが表示されます

### 方法2: .crxファイルからインストール（今後対応予定）

Chrome Web Storeへの公開を検討中です。

## 使用方法

1. 拡張機能をインストール後、シクロクロス公式リザルトページにアクセスします
   - 例: https://data.cyclocross.jp/race/24830

2. ページが読み込まれると、自動的にラップタイムが変換されます

3. 変換された部分は以下のように明示されます:
   - 緑色の背景色
   - 右上に⏱アイコン
   - ページ上部に通知バナー

4. 変換されたセルにマウスをホバーすると、元の経過時間が表示されます

## 機能の詳細

### 対応する時間フォーマット

- `MM:SS` （例: 9:28）
- `MM:SS.d` （例: 9:28.1）← 実際のページで使用
- `MM:SS.dd` （例: 9:28.12）
- `MM:SS.ddd` （例: 9:28.123）
- `HH:MM:SS` （例: 1:09:28）
- `HH:MM:SS.d` （例: 1:09:28.1）
- `HH:MM:SS.dd` （例: 1:09:28.12）
- `HH:MM:SS.ddd` （例: 1:09:28.123）

※ 小数点以下は1桁（1/10秒）、2桁（1/100秒）、3桁（1/1000秒）に対応

### 自動検出機能

拡張機能は以下の処理を自動で行います:

1. ページ内の `table__laptime` クラスを持つテーブルを検出
2. ヘッダー行の `cell__lapat` クラスを持つ列（「1周」「2周」など）を特定
3. 各選手の経過時間を読み取り、ネットラップタイムを計算
4. `<div class="text-right">` 要素内のテキストを更新
5. 変換されたセルに緑色の背景と⏱アイコンを表示

**特徴:**
- 元の経過時間は `data-original-time` 属性に保存され、ホバー時に表示
- DNS（欠場）や未完走の選手は自動的にスキップ
- ページ構造の変更にも柔軟に対応

### ダークモード対応

システムのダークモード設定に自動的に対応します。

### プリント対応

印刷時は変換マーカー（背景色、アイコン）が非表示になり、シンプルに出力されます。

## トラブルシューティング

### 拡張機能が動作しない場合

1. **ページをリロード**: Ctrl+R (Windows/Linux) または Cmd+R (Mac) でページを再読み込みしてください

2. **拡張機能の再読み込み**:
   - `chrome://extensions/` を開く
   - 本拡張機能の「再読み込み」ボタンをクリック

3. **コンソールログを確認**:
   - F12キーを押して開発者ツールを開く
   - Consoleタブを選択
   - 「Cyclocross Lap Time Converter」で始まるログメッセージを確認

### ラップタイムが変換されない場合

以下の原因が考えられます:

1. **ページ構造が想定と異なる**:
   - ページのHTMLが更新された可能性があります
   - Issueを作成して報告してください

2. **時間フォーマットが未対応**:
   - 対応していない時間フォーマットの可能性があります
   - Issueで具体例を報告してください

3. **テーブル構造の検出に失敗**:
   - ラップタイム列を自動検出できなかった可能性があります
   - ページのURLとともにIssueを作成してください

## 開発

### ファイル構成

```
cyclocross-extension/
├── manifest.json       # 拡張機能の設定ファイル
├── content.js          # ページ操作のメインスクリプト
├── styles.css          # スタイルシート
└── icons/              # アイコン画像（今後追加予定）
    ├── icon16.png
    ├── icon48.png
    └── icon128.png
```

### 主要な関数

- `parseTimeToMs(timeStr)`: 時間文字列をミリ秒に変換
- `formatMsToTime(ms, includeMs)`: ミリ秒を時間文字列に変換
- `detectLapTimeColumns(table)`: テーブルからラップタイム列を検出
- `convertLapTimes(table)`: ラップタイムを経過時間からネットタイムに変換

### デバッグ方法

1. 拡張機能をインストール
2. シクロクロスリザルトページを開く
3. F12キーで開発者ツールを開く
4. Consoleタブでログメッセージを確認

## 今後の予定

- [ ] アイコン画像の追加
- [ ] ON/OFF切り替え機能
- [ ] ベストラップの自動ハイライト
- [ ] ラップタイムのグラフ表示
- [ ] CSVエクスポート機能
- [ ] 他のシクロクロスサイトへの対応

## ライセンス

MIT License

## 貢献

バグ報告、機能要望、プルリクエストを歓迎します！

## 作者

[gentksb](https://github.com/gentksb)

## リンク

- [Issues](https://github.com/gentksb/ajocc-tools/issues)
- [Pull Requests](https://github.com/gentksb/ajocc-tools/pulls)
- [シクロクロス公式サイト](https://data.cyclocross.jp/)
