# Cyclocross Lap Time Converter - 機能ロードマップ

## 実装済み機能 ✅

### v1.0.0 - 基本的なラップタイム変換機能
- [x] 経過時間からネットラップタイムへの自動変換
- [x] 変換されたセルの視覚的な明示（緑色の背景、⏱アイコン）
- [x] ホバー時に元の経過時間を表示
- [x] 通知バナーの表示
- [x] 複数の時間フォーマットに対応（MM:SS.d など）
- [x] DNS行や未完走選手の自動スキップ
- [x] ダークモード対応
- [x] プリント対応

## 実装予定機能 📋

### Phase 1: ユーザーコントロール機能

#### 1.1 ON/OFF切り替えボタン 🔄
**優先度**: 高
**実装状況**: 未実装

**機能概要**:
- ブラウザのツールバーにあるアイコンをクリックすることで変換ON/OFFを切り替え
- 状態をローカルストレージに保存（ページリロード後も維持）
- OFFにすると元の経過時間表示に戻る
- アイコンの色や表示で現在の状態を明示

**技術仕様**:
- `chrome.storage.local` を使用して状態を保存
- `chrome.action.onClicked` でアイコンクリックを検出
- Content scriptにメッセージを送信して変換を制御
- 既に変換済みの場合は、DOM操作で元に戻す

**実装ファイル**:
- `background.js` (新規作成): バックグラウンドスクリプト
- `content.js` (修正): メッセージ受信とON/OFF制御
- `manifest.json` (修正): `background` と `storage` パーミッションを追加

---

### Phase 2: データ分析・可視化機能

#### 2.1 ベストラップのハイライト 🏆
**優先度**: 中
**実装状況**: 未実装

**機能概要**:
- 各選手の最速ラップを自動検出
- ベストラップのセルを金色または黄色でハイライト
- レース全体のベストラップを特別な色（例：赤色）でハイライト
- ホバー時にベストラップ情報を表示（例：「3周目がベストラップ」）

**技術仕様**:
- 各選手のラップタイムを配列で保持
- `Math.min()` で最小値を検出
- CSS クラス `best-lap` と `fastest-lap-overall` を追加
- 複数選手が同タイムの場合は全員をハイライト

**実装ファイル**:
- `content.js` (修正): ベストラップ検出ロジック
- `styles.css` (修正): ハイライト用スタイル

---

#### 2.2 ラップタイムのグラフ表示 📊
**優先度**: 中
**実装状況**: 未実装

**機能概要**:
- リザルトテーブルの下に折りたたみ可能なグラフエリアを追加
- 各選手のラップタイムを折れ線グラフで表示
- 複数選手を選択して比較可能
- グラフ上でホバーすると詳細情報を表示

**技術仕様**:
- Chart.js または D3.js を使用
- SVG または Canvas でグラフを描画
- 選手選択用のチェックボックスUIを追加
- グラフは遅延読み込み（ユーザーが展開した時に生成）

**実装ファイル**:
- `content.js` (修正): グラフデータの生成
- `graph.js` (新規作成): グラフ描画ロジック
- `styles.css` (修正): グラフUI用スタイル
- `manifest.json` (修正): Chart.jsライブラリの読み込み

---

#### 2.3 CSVエクスポート機能 💾
**優先度**: 低
**実装状況**: 未実装

**機能概要**:
- 変換後のネットラップタイムをCSV形式でダウンロード
- エクスポートボタンをテーブルの上または下に配置
- ファイル名に日付とレース名を含める（例：`20251109_ME2_laptimes.csv`）
- 元の経過時間も含めるオプション

**技術仕様**:
- JavaScript で CSV データを生成
- `Blob` と `URL.createObjectURL()` でダウンロードリンクを作成
- CSVフォーマット: 順位, 選手名, 1周, 2周, 3周, ...

**実装ファイル**:
- `content.js` (修正): CSV生成とダウンロードロジック
- `styles.css` (修正): エクスポートボタンのスタイル

---

#### 2.4 ラップ比較機能 🔍
**優先度**: 低
**実装状況**: 未実装

**機能概要**:
- 2人以上の選手を選択して、ラップごとのタイム差を表示
- 選手名の横にチェックボックスを追加
- 比較モード時は、選択した選手のラップタイム差をツールチップまたはポップアップで表示
- 「どの周で差がついたか」を視覚的に表示

**技術仕様**:
- 選手選択UIの追加
- 選択された選手のラップタイムを配列で保持
- 各ラップでの差分を計算（選手A - 選手B）
- 差分を色分け表示（プラス=赤、マイナス=青）

**実装ファイル**:
- `content.js` (修正): 比較ロジック
- `compare.js` (新規作成): 比較UI管理
- `styles.css` (修正): 比較UI用スタイル

---

## 実装の優先順位

1. **Phase 1.1**: ON/OFF切り替えボタン（最優先）
   - ユーザーが変換を制御できる基本機能

2. **Phase 2.1**: ベストラップのハイライト
   - 実装が比較的簡単で、価値が高い

3. **Phase 2.2**: ラップタイムのグラフ表示
   - データ可視化により分析価値を向上

4. **Phase 2.3**: CSVエクスポート機能
   - データの二次利用を可能に

5. **Phase 2.4**: ラップ比較機能
   - より高度な分析機能

## 技術的な検討事項

### パフォーマンス
- 大量のデータ（100人以上の選手）でも快適に動作するように最適化
- グラフ描画やDOM操作は必要な時だけ実行（遅延読み込み）

### 互換性
- 各機能は独立して動作するように設計
- 一部の機能が失敗しても他の機能に影響しない

### ユーザビリティ
- 設定UIはシンプルで直感的に
- デフォルト設定で多くのユーザーが満足できる状態に

### アクセシビリティ
- キーボード操作に対応
- スクリーンリーダーでも使用可能に
- ARIA属性の適切な使用

## バージョニング

- **v1.0.0**: 現在（基本的なラップタイム変換）
- **v1.1.0**: Phase 1 完了（ON/OFF切り替え）
- **v1.2.0**: Phase 2.1 完了（ベストラップハイライト）
- **v1.3.0**: Phase 2.2 完了（グラフ表示）
- **v1.4.0**: Phase 2.3 完了（CSVエクスポート）
- **v2.0.0**: 全Phase完了（ラップ比較含む）

## フィードバック

機能要望や改善提案は GitHub Issues でお願いします:
https://github.com/gentksb/ajocc-tools/issues
